<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>MemeMaster</title>
</head>

<body>
    <h1>
        <a href="read.html">MemeMaster</a>
    </h1>

    <canvas id="memeCanvas" width="300" height="300" style="border:1px solid"></canvas>
    <img id="img1" style="display: none" src="defaultimage.png" />

    <div id="memeText">
        <input type="file" id="imageLoader" name="imageLoader" />
        <br>
        Top: <input type="text" id="topText"><br>
        Bottom: <input type="text" id="bottomText"><br>
        Font Family:<select id="fontFamily">
            <option value="Impact">Impact</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Times">Times</option>
            <option value="Arial">Arial</option>
            <option value="serif">serif</option>
            <option value="sans-serif">sans-serif</option>
            <option value="Helvetica">Helvetica</option>
        </select><br>
        Font Size: <input type="text" id="fontSize"><br>
        <button onclick="applyMeme()">apply</button>
    </div>
    <button onclick="saveMeme()">save</button>
    <img id='output'>
    <br>
    <button id="logout">Log Out</button>
</body>
</html>

<!-- The script for Firebase -->
<script src="https://www.gstatic.com/firebasejs/5.6.0/firebase.js"></script>
<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyCdi5c7M5eVOWShwCXOIjxQcweE_flzrZQ",
        authDomain: "cse-134b-final-project.firebaseapp.com",
        databaseURL: "https://cse-134b-final-project.firebaseio.com",
        projectId: "cse-134b-final-project",
        storageBucket: "cse-134b-final-project.appspot.com",
        messagingSenderId: "828897432315"
    };
    firebase.initializeApp(config);
</script>

<!-- JavaScript code for log out button's onclick function-->
<script type="text/javascript">
    document.getElementById("logout").onclick = function () {
        logout();
    }
</script>
<script type="text/javascript">
    function showCanvas(topText = "Write Down", bottomText = "Your Text", img = document.getElementById("img1"), fontSize = 30, fontFamily = "Impact") {
        var canvas = document.getElementById("memeCanvas");
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, 300, 300);
        var font = fontSize + "px " + fontFamily;
        ctx.font = font;
        ctx.fillStyle = "white";
        ctx.strokeStyle = "black";
        ctx.textAlign = "center";
        ctx.fillText(topText, 150, 50);
        ctx.fillText(bottomText, 150, 270);
        ctx.strokeText(topText, 150, 50);
        ctx.strokeText(bottomText, 150, 270);
    };
    showCanvas();
</script>
<script>
    var imageLoader = document.getElementById('imageLoader');
    imageLoader.addEventListener('change', handleImage, false);
    var canvas = document.getElementById('memeCanvas');
    var ctx = canvas.getContext('2d');


    function handleImage(e) {
        var reader = new FileReader();
        reader.onload = function (event) {
            var img = new Image();
            img.onload = function () {
                ctx.drawImage(img, 0, 0, 300, 300);
                var topText = document.getElementById("topText").value;
                var bottomText = document.getElementById("bottomText").value;
                ctx.fillText(topText, 0, 50);
                ctx.fillText(bottomText, 0, 270);
            }
            img.src = event.target.result;
            document.getElementById("img1").src = img.src;
        }
        reader.readAsDataURL(e.target.files[0]);
    }
    function applyMeme() {
        var topText = document.getElementById("topText").value;
        var bottomText = document.getElementById("bottomText").value;
        var fontSize = document.getElementById("fontSize").value;
        var fontFamily = document.getElementById("fontFamily").value;
        showCanvas(topText, bottomText, document.getElementById("img1"), fontSize, fontFamily);
    };
    function saveMeme() {
        var topText = document.getElementById("topText").value;
        var bottomText = document.getElementById("bottomText").value;
        var fontSize = document.getElementById("fontSize").value;
        var fontFamily = document.getElementById("fontFamily").value;
        var imgSrc = document.getElementById("img1").src;
        var meme = {
            topText: topText,
            bottomText: bottomText,
            fontSize: fontSize,
            fontFamily: fontFamily,
            imgSrc: imgSrc
        };
        var database = firebase.database();
        var user = firebase.auth().currentUser;
        var ref = database.ref(user.uid);
        ref.push(meme);
        alert("saved!");
    }
</script>